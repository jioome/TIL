

## 5.1 AuthenticationProviderì˜ ì´í•´

AuthenticationProvider ê³„ì¸µì—ì„œ ì¸ì¦ ë…¼ë¦¬ë¥¼ ë‹´ë‹¹í•œë‹¤.

### 1. ì¸ì¦ í”„ë¡œì„¸ìŠ¤ ì¤‘ ìš”ì²­ ë‚˜íƒ€ë‚´ê¸°

ì¸ì¦ ì •ë³´ë¥¼ ë‹´ëŠ” Authentication ê°ì²´ êµ¬ì¡° ì´í•´

- `Authentication` : ì‚¬ìš©ìì˜ ì¸ì¦ ìš”ì²­ì„ í‘œí˜„í•˜ëŠ” ê°ì²´
- ì£¼ìš” ì†ì„± : **ìê²© ì¦ëª…(credentials),** **ì•„ì´ë””(principal), ì¶”ê°€ ì •ë³´(details)**
- **ì£¼ì²´ (principal)**
    - ì• í”Œë¦¬ì¼€ì´ì…˜ì— ì ‘ê·¼ì„ ìš”ì²­í•˜ëŠ” ì‚¬ìš©ì

ì£¼ìš” ì¸í„°í˜ì´ìŠ¤ 

- Authentication ê³„ì•½ì€ Principalë¥¼ ìƒì†í•œë‹¤.
- ì•”í˜¸ ì‚¬í•­ ë“±ì˜ ì„¸ë¶€ ì •ë³´ë¥¼ ë” ì¶”ê°€í•  ìˆ˜ ìˆë‹¤.

```java
public interface Authentication extends Principal, Serializable {
    Collection<? extends GrantedAuthority> getAuthorities(); // ê¶Œí•œ
    Object getCredentials(); // ë¹„ë°€ë²ˆí˜¸
    Object getDetails();     // ê¸°íƒ€ ì •ë³´ (IP, ì„¸ì…˜ ë“±)
    Object getPrincipal();   // ì‚¬ìš©ì ì•„ì´ë””
    boolean isAuthenticated(); // ì¸ì¦ ì—¬ë¶€
    void setAuthenticated(boolean isAuthenticated);
}

```

### 2. ë§ì¶¤í˜• ì¸ì¦ ë…¼ë¦¬ êµ¬í˜„

Spring Security ê¸°ë³¸ ì¸ì¦ ë°©ì‹ ì™¸ì—, ì„œë¹„ìŠ¤ì— ë§ëŠ” **ì§ì ‘ ì¸ì¦ ë¡œì§ì„ êµ¬í˜„í•˜ëŠ” ë°©ë²•**

- `AuthenticationProvider`ëŠ” ì¸ì¦ ê³µê¸‰ì ì—­í• 

ì»¤ìŠ¤í…€ ì¸ì¦ ë¡œì§ ì™œ í•„ìš”í• ê¹Œ?

- ID/PW ì™¸ì˜ ì¸ì¦ ìˆ˜ë‹¨ ì‚¬ìš© (ì´ë©”ì¼, OTP, API Key, ì¹´ë“œ ë“±)
- ì‚¬ìš©ì ìƒíƒœ ì¶”ê°€ ì¡°ê±´ ê²€ì‚¬ (íƒˆí‡´, íœ´ë©´ ë“±)

AuthenticationProvider ì¸í„°í˜ì´ìŠ¤ 

```java
public interface AuthenticationProvider {
    Authentication authenticate(Authentication authentication)
        throws AuthenticationException;

    boolean supports(Class<?> authentication);
}

```

- `authenticate()`: ì¸ì¦ ë¡œì§ ìˆ˜í–‰, ì„±ê³µ ì‹œ ì¸ì¦ ì •ë³´ ë°˜í™˜
- `supports()`: ì–´ë–¤ íƒ€ì…ì˜ ì¸ì¦ ìš”ì²­ì„ ì²˜ë¦¬í• ì§€ ì§€ì •

### 3. ë§ì¶¤í˜• ì¸ì¦ ë…¼ë¦¬ ì ìš©

Spring Securityì—ì„œ ì¸ì¦ ë°©ì‹ì„ ì»¤ìŠ¤í„°ë§ˆì´ì§•í•˜ë ¤ë©´CustomAuthenticationProviderë¥¼ ë§Œë“¤ê³ , ì„¤ì •ì— ë“±ë¡í•´ì•¼í•œë‹¤.

1. Provider ë§Œë“¤ê¸°

```java
@Component
public class CustomAuthenticationProvider implements AuthenticationProvider {

,,,,	
	
	@Override
	public boolean supports(Class<?> authenticationType) {
	    return authenticationType.equals(UsernamePasswordAuthenticationToken.class);
	}
	
	...}
```

- `supports()`ëŠ” ì´ Providerê°€ ì–´ë–¤ ì¸ì¦ ìš”ì²­ì„ ì²˜ë¦¬í• ì§€ ê²°ì •

```java
@Override
public Authentication authenticate(Authentication authentication) {
  String username = authentication.getName();
  String password = authentication.getCredentials().toString();

  UserDetails user = userDetailsService.loadUserByUsername(username);

  if (passwordEncoder.matches(password, user.getPassword())) {
      return new UsernamePasswordAuthenticationToken(username, password, user.getAuthorities());
  }
  throw new BadCredentialsException("ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜");
}
```

- authenticate()ëŠ” ì‹¤ì œ ë¡œê·¸ì¸ ì²˜ë¦¬ë¥¼ í•˜ëŠ” í•µì‹¬ ë©”ì„œë“œì¸ë°, ì—¬ê¸°ì„œ ìœ ì € ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•´ì„œ ì¸ì¦ ì„±ê³µ ì—¬ë¶€ë¥¼ ê²°ì •

1. Security ì„¤ì •ì— ë“±ë¡í•˜ê¸°

```java
@Configuration
public class ProjectConfig extends WebSecurityConfigurerAdapter {
    @Autowired
    private AuthenticationProvider authenticationProvider;

    @Override
    protected void configure(AuthenticationManagerBuilder auth) {
        auth.authenticationProvider(authenticationProvider);
    }
}
```

- ProviderëŠ” ë°˜ë“œì‹œ ì„¤ì •ì— `.authenticationProvider()`ë¡œ ë“±ë¡í•´ì•¼ ì‹¤ì œë¡œ ë™ì‘

- ìŠ¤í”„ë§ ì‹œíë¦¬í‹° ë“± í”„ë ˆì„ì›Œí¬ëŠ” ê°œë°œì í‘œì¤€ì´ê³  ì‹ ë¢°ì„±ì´ ìˆê¸° ë•Œë¬¸ì— ê°€ëŠ¥í•˜ë©´ ê³µë¶€í•´ì„œ ì‚¬ìš©í•˜ê¸°

## 5.2 Security Context ì´ìš©

- ë³´ì•ˆ ì»¨í…ìŠ¤íŠ¸ì˜ ì‘ë™ ë°©ì‹ê³¼ ë°ì´í„° ì ‘ê·¼ ë°©ë²• í•™ìŠµ

SecurityContext ì¸í„°í˜ì´ìŠ¤ êµ¬ì¡° 

```java
public interface SecurityContext extends Serializable {
    Authentication getAuthentication();
    void setAuthentication(Authentication authentication);
}

```

- SecurityContext
    - ì¸ì¦ ì™„ë£Œ í›„ Authentication ê°ì²´ë¥¼ ì €ì¥í•˜ëŠ” ì¸ìŠ¤í„´ìŠ¤

**ë³´ì•ˆ ì»¨í…ìŠ¤íŠ¸ë¥¼ ê´€ë¦¬í•˜ëŠ” 3ê°€ì§€ ëª¨ë“œ** 

5.2.1. ë³´ì•ˆ ì»¨í…ìŠ¤íŠ¸ë¥¼ ìœ„í•œ ë³´ìœ  ì „ëµ ì´ìš©

- SecurityContextHolder
    - SecurityContextHolder ë¥¼ í†µí•´ SecurityContext ê´€ë¦¬
    - **ê¸°ë³¸ ì „ëµ: `MODE_THREADLOCAL`**
        - **ê¸°ë³¸ê°’, í•œ ìŠ¤ë ˆë“œ ì•ˆì—ì„œë§Œ ì¸ì¦ ì •ë³´ë¥¼ ìœ ì§€í•¨**
        - `ThreadLocal`ì„ ì‚¬ìš©í•´ì„œ, ê°™ì€ ìŠ¤ë ˆë“œ ì•ˆì—ì„œë§Œ `SecurityContext`ë¥¼ ê³µìœ í•¨
- Authentication ê°ì²´ ì–»ëŠ” ë°©ë²•
    - ìŠ¤í”„ë§ ë¶€íŠ¸ê°€ í˜„ì¬ Authenticationì„ ë©”ì„œë“œ ë§¤ê°œ ë³€ìˆ˜ì— ì£¼ì…

```java
@GetMapping("/hello")
public String hello(Authentication a) {  
    return "Hello, " + a.getName() + "!";
}

```

5.2.2. ë¹„ë™ê¸° í˜¸ì¶œì„ ìœ„í•œ ë³´ìœ  ì „ëµ

- ë‹¤ë¥¸ ìŠ¤ë ˆë“œë¡œ ì‹¤í–‰ë˜ëŠ” ì—”ë“œí¬ì¸íŠ¸ â†’ @Async ì‚¬ìš©
    - ë¬¸ì œ : ìƒˆë¡œìš´ ìŠ¤ë ˆë“œì—ì„œ ì‹¤í–‰ë˜ê¸° ë•Œë¬¸ì— ê¸°ì¡´ì— ì €ì¥ëœ ì¸ì¦ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í•¨

ğŸ“Œ í•´ê²° ë°©ë²•: **`MODE_INHERITABLETHREADLOCAL`**

- **ìì‹ ìŠ¤ë ˆë“œì— `SecurityContext` ë³µì‚¬í•´ì„œ ì „ë‹¬**
- í•´ë‹¹ ì„¤ì • ì—†ìœ¼ë©´ NullPointerException ë°œìƒ

```java
@Configuration
@EnableAsync
public class ProjectConfig {
    @Bean
    public InitializingBean initializingBean() {
        return () -> SecurityContextHolder.setStrategyName(
            SecurityContextHolder.MODE_INHERITABLETHREADLOCAL);
    }
}

```

5.2.3 ë…ë¦½í˜• ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ìœ„í•œ ë³´ìœ  ì „ëµ

- **MODE_GLOBAL : ì• í”Œë¦¬ì¼€ì´ì…˜ ì „ì—­ì—ì„œ ë‹¨ í•˜ë‚˜ì˜ ë³´ì•ˆ ì»¨í…ìŠ¤íŠ¸ë¥¼ ê³µìœ í•˜ëŠ” ë°©ì‹**
    - ì“°ë ˆë“œë§ˆë‹¤ ì¸ì¦ ì •ë³´ê°€ ì„ì¼ ìˆ˜ ìˆì–´ ìœ„í—˜í•˜ê¸° ë•Œë¬¸ì— ì˜ ì“°ì´ì§€ ì•ŠìŒ
- `MODE_INHERITABLETHREADLOCAL` ì™€ ë§ˆì°¬ê°€ì§€ë¡œ SecurityContextHolder.setStrategyName() or spring.security.strategy ì„¤ì •ì„ í†µí•´ ì „ëµì„ ë³€ê²½í•œë‹¤.

- ìœ ì˜ : SecurityContextëŠ” ìŠ¤ë ˆë“œ ì•ˆì „ì„ ì§€ì›í•˜ì§€ ì•ŠìŒìœ¼ë¡œ, ëª¨ë“  ìŠ¤ë ˆë“œê°€ SecurityContext ê°ì²´ì— ì ‘ê·¼í•  ìˆ˜ ìˆì–´ ë™ì‹œ ì ‘ê·¼ ì²˜ë¦¬ë¥¼ í•´ì•¼í•œë‹¤.

5.2.4 DelegatingSecurityContextRunnableë¡œ ë³´ì•ˆ ì»¨í…ìŠ¤íŠ¸ ì „ë‹¬ 

DelegatingSecurityContextRunnable / Callable

- ë‹¤ë¥¸ ìŠ¤ë ˆë“œì— ë³´ì•ˆ ì»¨í…ìŠ¤íŠ¸ë¥¼ ë³µì‚¬í•´ì„œ ì „ë‹¬í•˜ëŠ” Runnable/Callable ë˜í¼
    - í˜„ì¬ ìŠ¤ë ˆë“œì˜ ë³´ì•ˆ ì •ë³´ë¥¼ ìƒˆ ìŠ¤ë ˆë“œì—ë„ ë³µì‚¬í•´ì„œ ê°™ì´ ì‹¤í–‰ë˜ê²Œ ë§Œë“¤ì–´ì¤Œ
- `DelegatingSecurityContextCallable`ì´ ì—†ìœ¼ë©´ ì¸ì¦ ì •ë³´ê°€ ì „ë‹¬ë˜ì§€ ì•ŠìŒ

5.2.4 DelegatingSecurityContextExecutorServiceë¡œ ë³´ì•ˆ ì»¨í…ìŠ¤íŠ¸ ì „ë‹¬ 

**ExecutorService ì „ì²´ì— ë³´ì•ˆ ì»¨í…ìŠ¤íŠ¸ ì „ë‹¬ì´ í•„ìš”í•œ ê²½ìš°**

- ì‘ì—…ì—ì„œ ì²˜ë¦¬í•˜ì§€ ì•Šê³  ìŠ¤ë ˆë“œ í’€ì—ì„œ ì „íŒŒ ê´€ë¦¬
- ExecutorService ì „ì²´ ê°ì‹¸ì„œ ìë™ ë³´ì•ˆ ì»¨í…ìŠ¤íŠ¸ ì „ë‹¬

### 5.3 HTTP Basic ì¸ì¦ê³¼ ì–‘ì‹ ê¸°ë°˜ ë¡œê·¸ì¸ ì¸ì¦ ì´í•´í•˜ê¸°

5.3.1 HTTP Basic ì¸ì¦

HTTP Basic ì¸ì¦ì€ ê¸°ë³¸ ì¸ì¦ ë°©ì‹ì´ë‹¤.

- ê¸°ë³¸ ì„¤ì •

```java
@Configuration
public class ProjectConfig extends WebSecurityConfigurerAdapter {
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http.httpBasic(); // ê¸°ë³¸ HTTP Basic ì¸ì¦ ì„¤ì •
        http.authorizeRequests().anyRequest().authenticated();
    }
}

```

- ì¶”ê°€ ì„¤ì • ì†Œê°œ
    - ì˜ì—­ ì´ë¦„(Realm) ì„¤ì •
    - ì¸ì¦ ì‹¤íŒ¨ ë©”ì‹œì§€ ì»¤ìŠ¤í„°ë§ˆì´ì§•

5.3.2 ì–‘ì‹ ê¸°ë°˜ ë¡œê·¸ì¸ ì¸ì¦ (formLogin)

- formLogin() ë©”ì†Œë“œë¥¼ ì´ìš©í•´ HTML ë¡œê·¸ì¸ í˜ì´ì§€ë¥¼ ê¸°ì¡´ ì œê³µí•œë‹¤.

- ê¸°ë³¸ formLogin ì„¤ì •

```
http.formLogin(); // ê¸°ë³¸ ë¡œê·¸ì¸ í¼ í™œì„±í™”
http.authorizeRequests().anyRequest().authenticated();
```

- ë¡œê·¸ì¸ ì„±ê³µ í›„ ë¦¬ë‹¤ì´ë ‰íŠ¸ ì„¤ì •

```java
http.formLogin()
.defaultSuccessUrl("/home", true);
```

ì»¨íŠ¸ë¡¤ëŸ¬ 

- `resources/static/home.html` ì— ë·° íŒŒì¼ì„ ë‘ë©´ ë¸Œë¼ìš°ì €ë¡œ ì ‘ì† ì‹œ ìë™ ë¦¬ë‹¤ì´ë ‰íŠ¸ë¨

```java
@Controller
public class HelloController {
    @GetMapping("/home")
    public String home() {
        return "home.html";
    }
}

```

- HTTP Basic
    - ê°„ë‹¨í•œ ì¸ì¦ ë°©ì‹, REST APIì— ì í•©
    - httpBasic()
- Form Login
    - HTML ë¡œê·¸ì¸ í¼, ì‚¬ìš©ì ê²½í—˜ ì¢‹ìŒ
    - formLogin()
- ì»¤ìŠ¤í„°ë§ˆì´ì§•
    - EntryPoint, SuccessHandler ë“± í™•ì¥ ê°€ëŠ¥
